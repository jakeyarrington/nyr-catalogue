<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="dist/css/app.min.css"  media="screen,projection"/>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Neal's Yard Catalogue</title>
  </head>

  <body ng-app="nyr">

    <div class="progress loading-page">
        <div class="indeterminate"></div>
    </div>

      <nav>
        <div class="nav-wrapper">
        <ul id="nav-mobile">
          <li>
            <a href="#" data-target="slide-out" class="sidenav-trigger tooltipped" data-position="right" data-tooltip="Available Items">
              <i class="material-icons">shopping_basket</i>
            </a>
          </li>
          <li>
            <a href="sass.html" class="tooltipped" data-position="right" data-tooltip="Share Catalogue">
              <span class="material-icons">share</span>
            </a>
          </li>
          <li>
            <a href="badges.html" class="tooltipped" data-position="right" data-tooltip="Your Favourites">
              <span class="material-icons">star</span>
            </a>
          </li>
          <li>
            <a href="collapsible.html" class="tooltipped" data-position="right" data-tooltip="Contact Consultant">
              <span class="material-icons">contact_phone</span>
            </a>
          </li>
        </ul>
      </div>
      </nav>

      <ul id="basket_sidebar" class="sidenav" ng-controller="basket">
        <li>
          <header>
            <span ng-bind="catalogue.pages.data[catalogue.active_page].length"></span> Item(s) on Page <span ng-bind="catalogue.active_page"></span>
          </header>
        </li>
        <li>
           <div class="row" ng-repeat="item in catalogue.pages.data[catalogue.active_page]">
            <div class="col s12">
              <div class="card">
                <div class="card-image">
                  <img ng-src="{{item.cover}}">
                  
                </div>
                <div class="card-content">
                  <h6><span ng-bind="item.name">Card Title</span></h6>
                  <p ng-bind="item.description"></p>
                </div>
                <div class="card-action" ng-if="!item.video">
                  <a ng-href="{{item.link}}" target="_blank" ng-if="item.link">Purchase</a>
                  <a href="#" ng-if="item.favourite">Favourite</a>
                </div>
                <div class="card-action" ng-if="item.video">
                  <a ng-href="{{item.link}}" target="_blank" ng-if="item.link">Visit</a>
                  <a class="modal-trigger" href="#video_modal" ng-if="item.video" ng-click="open_video_modal(item)">Watch</a>
                </div>
              </div>
            </div>
        </div>
        </li>
       
      </ul>

      <div class="flip-book-container solid-container" ng-controller="flipbook"></div>

      <div ng-controller="videomodal">
          <div id="video_modal" class="modal">
            <div class="modal-content">
              <!-- <h4 ng-bind="catalogue.modal.name">Modal Header</h4> -->
              <!-- <p ng-bind="catalogue.modal.description">A bunch of text</p> -->
              <div ng-bind-html="catalogue.modal.video | safeHtml"></div>
            </div>
            <div class="modal-footer">
              <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
            </div>
          </div>
      </div>
      
          

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="dist/js/app.min.js?v=1"></script>
    <script src="https://code.angularjs.org/1.2.20/angular-sanitize.min.js"></script>
    <script src="dist/js/3d-flip-book/js/libs/html2canvas.min.js"></script>
    <script src="dist/js/3d-flip-book/js/libs/three.min.js"></script>
    <script src="dist/js/3d-flip-book/js/libs/pdf.min.js"></script>
    <script src="dist/js/3d-flip-book/js/dist/3dflipbook.js"></script>

    

    <script>
      
      var pages = [];
      var page_index = 0;
      var app = angular.module('nyr', []);

    app.filter('safeHtml', function ($sce) {
        return function (val) {
            return $sce.trustAsHtml(val);
        };
    });

      const basket_sidebar = document.getElementById('basket_sidebar');

      var basketController = app.controller('basket', ['$scope', 'catalogues', '$timeout', function($scope, catalogues, $timeout) {

        catalogues.http.then((e) => {
            /* Set Data */
            catalogues.set(e);

            console.log(catalogues.get());
            
            $timeout(function() {
                $scope.catalogue = catalogues;
                $scope.$apply();
            });

            $scope.open_video_modal = function($item) {
                $timeout(function() {
                    catalogues.modal = $item;
                    console.log($item);
                    $scope.$apply();
                });
            }
            
        })

      }]);

      var videoModalController = app.controller('videomodal', ['$scope', 'catalogues', '$timeout', function($scope, catalogues, $timeout) {

            catalogues.http.then((e) => {
                /* Set Data */
                catalogues.set(e);

                $timeout(function() {
                    $scope.catalogue = catalogues;
                    $scope.$apply();
                    console.log($scope.catalogue);
                });


            });

      }]);

      var flipBookController = app.controller('flipbook', ['$scope', 'catalogues', '$timeout', function($scope, catalogues, $timeout) {

        $scope.page_index = 0;

        catalogues.http.then((e) => {
            /* Set Data */
            catalogues.set(e);

            /* Init Flipbook */
            $scope.flipbook = $('.solid-container').FlipBook({pdf: encodeURI(catalogues.get().pdf_file)});

            /* Setup loop for Page Change */
            setInterval(function() {

              if(typeof $scope.flipbook.book == 'undefined') {
                return;
              } else {
                $('.loading-page').remove();
              }

              $scope.this_page_index = $scope.flipbook.book.getPage()+1;
              if($scope.this_page_index !== $scope.page_index) {
                $scope.page_index = $scope.this_page_index;

                $timeout(function() {
                    catalogues.active_page = $scope.this_page_index;
                    $scope.$apply();
                });

                console.log('Page Index', $scope.page_index);

                if(typeof catalogues.pages.data[$scope.page_index] !== 'undefined') {

                  $scope.active_items = catalogues.pages.data[$scope.page_index];
                  var length = catalogues.pages.data[$scope.page_index].length;
                  
                  M.toast({
                    html: ('There '+ (length == 1 ? 'is' : 'are') +' % item'+ (length == 1 ? '' : 's') +' to view <button class="btn-flat toast-action" onclick="M.Sidenav.getInstance(basket_sidebar).open()">View</button>').replace('%', length),
                    displayLength: 5000,

                  });
                }

              }

            }, 100);

        })

      }]);

      basketController.factory('catalogues', function() {

        var http = new Promise((resolve, reject) => {
          $.ajax({
            url: 'https://objects.yarringtoncontent.co.uk/nyr/catalogue/catalogue.json',
            type: 'GET',
            success: function (data) {
              resolve(data)
            },
            error: function (error) {
              reject(error)
            },
          });
        });

        var response = {
            http: http,
            data: null,
            loaded: false,
            active_page: 0,
            modal: [],
            pages: {
                data: [],
                map: function() {
                    var $this = response;
                    var catalogue = $this.get();
                    for (var i = catalogue.items.length - 1; i >= 0; i--) {
                        var item = catalogue.items[i];
                        if(typeof $this.pages.data[item.page] == 'undefined') {
                            $this.pages.data[item.page] = [];
                        }

                        $this.pages.data[item.page].push(item);
                    }
                }
            },
            set: function(data) {
                var $this = response;

                if(this.loaded) {
                    return this;
                }

                this.data = data;
                this.loaded = true;
                this.pages.map();
                this.http = {
                    then: function() {
                        $this.data.cached = true;
                        return $this.data;
                    }
                };

                return this;
            },
            get: function(index) {
                var $this = response;
                return $this.data[index ? index : 0];
            }
        };

        return response;

      });

        (function($) {
            $(document).ready(function(){
                $('.sidenav').sidenav();
                $('.tooltipped').tooltip();
                $('.modal').modal();
            });
        })(jQuery);

      
          
    </script>

  </body>
</html>