<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="dist/css/app.min.css"  media="screen,projection"/>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Neal's Yard Catalogue</title>
  </head>

  <body ng-app="nyr">

    <div class="progress loading-page">
        <div class="indeterminate"></div>
    </div>

      <nav>
        <div class="nav-wrapper">
        <ul id="nav-mobile">
          <li>
            <a href="#" data-target="slide-out" class="sidenav-trigger tooltipped" data-position="right" data-tooltip="Available Items">
              <i class="material-icons">shopping_basket</i>
            </a>
          </li>
          <li>
            <a href="sass.html" class="tooltipped" data-position="right" data-tooltip="Share Catalogue">
              <span class="material-icons">share</span>
            </a>
          </li>
          <li>
            <a href="badges.html" class="tooltipped" data-position="right" data-tooltip="Your Favourites">
              <span class="material-icons">star</span>
            </a>
          </li>
          <li>
            <a href="collapsible.html" class="tooltipped" data-position="right" data-tooltip="Contact Consultant">
              <span class="material-icons">contact_phone</span>
            </a>
          </li>
        </ul>
      </div>
      </nav>

      <ul id="basket_sidebar" class="sidenav" ng-controller="basket">
        <li>
          <header>
            13 Items on Page
          </header>
        </li>
        <li>
           <div class="row">
            <div class="col s12">
              <div class="card">
                <div class="card-image">
                  <img src="https://materializecss.com/images/sample-1.jpg">
                  <span class="card-title">Card Title</span>
                </div>
                <div class="card-content">
                  <p>I am a very simple card. I am good at containing small bits of information.
                  I am convenient because I require little markup to use effectively.</p>
                </div>
                <div class="card-action">
                  <a href="#">Purchase</a>
                  <a href="#">
                    Favourite
                  </a>
                </div>
              </div>
            </div>
            <div class="col s12">
              <div class="card">
                <div class="card-image">
                  <img src="https://materializecss.com/images/sample-1.jpg">
                  <span class="card-title">Card Title</span>
                </div>
                <div class="card-content">
                  <p>I am a very simple card. I am good at containing small bits of information.
                  I am convenient because I require little markup to use effectively.</p>
                </div>
                <div class="card-action">
                  <a href="#">Purchase</a>
                  <a href="#">
                    Favourite
                  </a>
                </div>
              </div>
            </div>
            <div class="col s12">
              <div class="card">
                <div class="card-image">
                  <img src="https://materializecss.com/images/sample-1.jpg">
                  <span class="card-title">Card Title</span>
                </div>
                <div class="card-content">
                  <p>I am a very simple card. I am good at containing small bits of information.
                  I am convenient because I require little markup to use effectively.</p>
                </div>
                <div class="card-action">
                  <a href="#">Purchase</a>
                  <a href="#">
                    Favourite
                  </a>
                </div>
              </div>
            </div>
            <div class="col s12">
              <div class="card">
                <div class="card-image">
                  <img src="https://materializecss.com/images/sample-1.jpg">
                  <span class="card-title">Card Title</span>
                </div>
                <div class="card-content">
                  <p>I am a very simple card. I am good at containing small bits of information.
                  I am convenient because I require little markup to use effectively.</p>
                </div>
                <div class="card-action">
                  <a href="#">Purchase</a>
                  <a href="#">
                    Favourite
                  </a>
                </div>
              </div>
            </div>
          </div>
        </li>
       
      </ul>

      <div class="flip-book-container solid-container" ng-controller="flipbook"></div>
      
          

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="dist/js/app.min.js?v=1"></script>
    <script src="dist/js/3d-flip-book/js/libs/html2canvas.min.js"></script>
    <script src="dist/js/3d-flip-book/js/libs/three.min.js"></script>
    <script src="dist/js/3d-flip-book/js/libs/pdf.min.js"></script>
    <script src="dist/js/3d-flip-book/js/dist/3dflipbook.js"></script>

    

    <script>
      
      var pages = [];
      var page_index = 0;
      var app = angular.module('nyr', []);
      
      const basket_sidebar = document.getElementById('basket_sidebar');

      var basketController = app.controller('basket', ['$scope', 'catalogues', function($scope, catalogues) {

        catalogues.http.then((e) => {
            /* Set Data */
            catalogues.set(e);

            console.log(catalogues.get());
        })

      }]);

      var flipBookController = app.controller('flipbook', ['$scope', 'catalogues', function($scope, catalogues) {

        $scope.page_index = 0;

        catalogues.http.then((e) => {
            /* Set Data */
            catalogues.set(e);

            /* Init Flipbook */
            $scope.flipbook = $('.solid-container').FlipBook({pdf: encodeURI(catalogues.get().pdf_file)});

            /* Setup loop for Page Change */
            setInterval(function() {

              if(typeof $scope.flipbook.book == 'undefined') {
                return;
              } else {
                $('.loading-page').remove();
              }

              $scope.this_page_index = $scope.flipbook.book.getPage()+1;
              if($scope.this_page_index !== $scope.page_index) {
                $scope.page_index = $scope.this_page_index;

                console.log('Page Index', $scope.page_index);

                if(typeof catalogues.pages.data[$scope.page_index] !== 'undefined') {
                  var length = catalogues.pages.data[$scope.page_index].length;
                  M.toast({
                    html: ('There '+ (length == 1 ? 'is' : 'are') +' % item'+ (length == 1 ? '' : 's') +' to view <button class="btn-flat toast-action" onclick="M.Sidenav.getInstance(basket_sidebar).open()">View</button>').replace('%', length),
                    displayLength: 5000,

                  });
                }

              }

            }, 100);

        })

      }])

      basketController.factory('catalogues', function() {

        var http = new Promise((resolve, reject) => {
          $.ajax({
            url: 'https://nyr-catalogue-wp.yarrington.app/wp-json/app/v1/catalogues',
            type: 'GET',
            success: function (data) {
              resolve(data)
            },
            error: function (error) {
              reject(error)
            },
          });
        });

        var response = {
            http: http,
            data: null,
            loaded: false,
            pages: {
                data: [],
                map: function() {
                    var $this = response;
                    var catalogue = $this.get();
                    for (var i = catalogue.items.length - 1; i >= 0; i--) {
                        var item = catalogue.items[i];
                        if(typeof $this.pages.data[item.page]) {
                            $this.pages.data[item.page] = [];
                        }

                        $this.pages.data[item.page].push(item);
                    }
                }
            },
            set: function(data) {
                var $this = response;

                if(this.loaded) {
                    return this;
                }

                this.data = data;
                this.loaded = true;
                this.pages.map();
                this.http = {
                    then: function() {
                        $this.data.cached = true;
                        return $this.data;
                    }
                };

                return this;
            },
            get: function(index) {
                var $this = response;
                return $this.data[index ? index : 0];
            }
        };

        return response;

      });

      $('.sidenav').sidenav();
      $('.tooltipped').tooltip();

      (function($) {

        return;
        $(document).ready(function(){


          $.get(catalogue_url, function(data) {

            const catalogue = data[0];
            const all_catalogues = data;
            

            // Organise Pages
            for (var i = catalogue.items.length - 1; i >= 0; i--) {
              var item = catalogue.items[i];

              if(typeof pages[item.page] == 'undefined') {
                pages[item.page] = [];
              }

              pages[item.page].push(item);
            }

            // Build Flipbook
            const flipbook = $('.solid-container').FlipBook({pdf: encodeURI(catalogue.pdf_file)});

            setInterval(function() {

              if(typeof flipbook !== 'object' || typeof flipbook.book == 'undefined') {
                return;
              } else {
                $('.loading-page').remove();
              }

              var this_page_index = flipbook.book.getPage()+1;
              if(this_page_index !== page_index) {
                page_index = this_page_index;

                console.log('Page Index', page_index);

                if(typeof pages[page_index] !== 'undefined') {
                  console.log(pages[page_index]);

                  var length = pages[page_index].length;
                  M.toast({
                    html: ('There '+ (length == 1 ? 'is' : 'are') +' % item'+ (length == 1 ? '' : 's') +' to view <button class="btn-flat toast-action" onclick="M.Sidenav.getInstance(basket_sidebar).open()">View</button>').replace('%', length),
                    displayLength: 5000,

                  });
                }

              }

            }, 100);

          });

          

        });

      })(jQuery);
          
    </script>

  </body>
</html>